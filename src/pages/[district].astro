---
import Layout from '../layouts/Layout.astro';
import SidebarFilter from '../components/SidebarFilter.astro';
import CardRoom from '../components/CardRoom.astro';
import CommitmentFooter from '../components/CommitmentFooter.astro';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const dataPath = path.join(process.cwd(), 'public', 'data.json');
  const jsonData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
  const validRooms = jsonData.rooms.filter(r => r.status === 'active' || r.status === 'rented');

  return [
    { params: { district: 'tan-binh' }, props: { districtName: 'Tân Bình', allRooms: validRooms.filter(r => r.district === 'Tân Bình') } },
    { params: { district: 'phu-nhuan' }, props: { districtName: 'Phú Nhuận', allRooms: validRooms.filter(r => r.district === 'Phú Nhuận') } }
  ];
}

const { districtName, allRooms } = Astro.props;

// LOGIC SẮP XẾP SERVER-SIDE
const activeRooms = allRooms.filter(r => r.status === 'active');
const rentedRooms = allRooms.filter(r => r.status === 'rented');

// Sắp xếp Active: Ưu tiên có Promotion
activeRooms.sort((a, b) => (b.promotion ? 1 : 0) - (a.promotion ? 1 : 0));

// Rented: Lấy 12 căn mới nhất
const limitedRentedRooms = rentedRooms.slice(0, 12);
const initialDisplayRooms = [...activeRooms, ...limitedRentedRooms];

// Metadata
const pageTitle = `Cho thuê phòng trọ Quận ${districtName} - Thọ Cho Thuê Trọ`;
const pageDesc = `Danh sách phòng trọ Quận ${districtName} giá tốt, tiện nghi, giờ giấc tự do. Cập nhật mới nhất.`;

// Schema ItemList
const schemaItemList = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": initialDisplayRooms.map((room, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `https://thochothuetro.com/${room.district === 'Tân Bình' ? 'tan-binh' : 'phu-nhuan'}/${room.id}`,
    "name": `Cho thuê ${room.type} mã ${room.room_code}`
  }))
};
---

<Layout title={pageTitle} description={pageDesc} image="/logo.png">
    
    <script type="application/ld+json" set:html={JSON.stringify(schemaItemList)} />

    <div class="bg-light border-bottom py-3 mb-4">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1 small">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                    <li class="breadcrumb-item active text-dark fw-bold" aria-current="page">Quận {districtName}</li>
                </ol>
            </nav>
            <h1 class="h3 fw-bold text-uppercase mb-0 text-dark">
                Phòng trọ Quận <span class="text-warning">{districtName}</span>
            </h1>
        </div>
    </div>

    <div class="container pb-5">
        <div class="row">
            <div class="col-lg-3 mb-4 mb-lg-0">
                <SidebarFilter />
            </div>

            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-none d-md-block text-muted small fst-italic">
                        * Hiển thị {initialDisplayRooms.length} kết quả
                    </div>
                    <div class="d-flex align-items-center ms-auto">
                        <label for="sort-select" class="small fw-bold me-2 text-muted">Sắp xếp:</label>
                        <select id="sort-select" class="form-select form-select-sm border-warning shadow-sm" style="width: auto; font-weight: 500;">
                            <option value="default">Mặc định</option>
                            <option value="price-asc">Giá thấp đến cao</option>
                            <option value="price-desc">Giá cao đến thấp</option>
                        </select>
                    </div>
                </div>

                <div class="row g-2 g-md-3" id="district-room-container">
                    {initialDisplayRooms.map((room, idx) => (
                        <div class="col-6 col-md-4 room-item"
                             data-district={room.district}
                             data-price={room.price}
                             data-type={room.type}
                             data-status={room.status}
                             data-promotion={room.promotion ? "yes" : "no"}
                             data-keypoint={room.keypoint ? room.keypoint.toLowerCase() : ""}
                             data-pet={room.pet ? "yes" : "no"}
                             data-has-image={(room.image_detail && room.image_detail.length > 0) ? "yes" : "no"}
                             data-district-index={idx}>
                             
                             <CardRoom room={room} priority={idx < 6} />
                        
                        </div>
                    ))}
                </div>
                
                <div id="no-result" class="text-center py-5 d-none">
                    <div class="mb-3"><i class="fas fa-search fa-3x text-muted opacity-25"></i></div>
                    <p class="text-muted small mb-3">Không tìm thấy phòng phù hợp.</p>
                    <button class="btn btn-warning text-dark fw-bold shadow-sm" onclick="window.location.href=window.location.pathname">
                        Xóa bộ lọc
                    </button>
                </div>

                <div class="text-center mt-5 mb-4" id="load-more-wrapper">
                    <button id="btn-load-more" class="btn btn-outline-warning text-dark fw-bold px-5 rounded-pill shadow-sm py-2">
                        Xem thêm phòng <i class="fas fa-chevron-down ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <CommitmentFooter />

</Layout>

<script is:inline>
    // Định nghĩa biến toàn cục cho script inline
    let itemsToShow = 12; // Mặc định hiển thị 12
    if (window.innerWidth < 768) itemsToShow = 8; // Mobile hiện 8
    
    const ITEMS_PER_LOAD = 6;
    let lastFilterParams = '';

    function handleLoadMore() {
        itemsToShow += ITEMS_PER_LOAD;
        renderRooms();
    }

    function renderRooms() {
        const params = new URLSearchParams(window.location.search);
        const currentFilterParams = params.toString();
        
        // Reset phân trang nếu bộ lọc thay đổi
        if (lastFilterParams !== currentFilterParams) {
            itemsToShow = (window.innerWidth < 768) ? 8 : 12;
            lastFilterParams = currentFilterParams;
        }

        const fType = (params.get('type') || 'all').toLowerCase();
        const fPrice = params.get('price');
        const fAmenitiesRaw = params.get('amenities') ? params.get('amenities').split(',') : [];
        const fAmenities = fAmenitiesRaw.map(a => (a || '').toString().trim().toLowerCase());
        
        const specialGroup = ['ban công', 'cửa sổ'];
        const selectedSpecial = fAmenities.filter(a => specialGroup.includes(a));
        const selectedNormal = fAmenities.filter(a => !specialGroup.includes(a));
        
        const sortEl = document.getElementById('sort-select');
        const sortMode = sortEl ? sortEl.value : 'default';

        const allDomItems = Array.from(document.querySelectorAll('.room-item'));
        
        // 1. LỌC
        const filteredItems = allDomItems.filter(item => {
            let matches = true;

            const itemDistrict = item.getAttribute('data-district');
            if (params.get('district') && params.get('district') !== 'all' && itemDistrict !== params.get('district')) matches = false;

            const itemType = (item.getAttribute('data-type') || '').toLowerCase();
            if (matches && fType !== 'all' && itemType !== fType) matches = false;

            if (matches && fPrice && fPrice !== 'all') {
                const priceAttr = item.getAttribute('data-price');
                const price = priceAttr ? parseInt(priceAttr) / 1000000 : 0;
                
                if (fPrice === 'duoi-5' && price >= 5) matches = false;
                if (fPrice === '5to8' && (price < 5 || price >= 8)) matches = false;
                if (fPrice === 'over8' && price < 8) matches = false;
            }

            if (matches && fAmenities.length > 0) {
                const keypoints = (item.getAttribute('data-keypoint') || '').toLowerCase();
                const petAllowed = item.getAttribute('data-pet') === 'yes';
                
                for (let ami of selectedNormal) {
                    if (!ami) continue;
                    if (ami === 'nuôi pet' || ami === 'nuoi pet') {
                        if (!keypoints.includes('pet') && !keypoints.includes('thú cưng') && !petAllowed) { matches = false; break; }
                    } else {
                        if (!keypoints.includes(ami)) { matches = false; break; }
                    }
                }

                if (matches && selectedSpecial.length > 0) {
                    let hasAtLeastOne = false;
                    if (selectedSpecial.includes('ban công') && keypoints.includes('ban công')) hasAtLeastOne = true;
                    if (selectedSpecial.includes('cửa sổ') && keypoints.includes('cửa sổ')) hasAtLeastOne = true;
                    if (!hasAtLeastOne) matches = false;
                }
            }

            return matches;
        });

        // 2. SẮP XẾP
        const getPrice = (el) => parseInt(el.getAttribute('data-price') || '0');
        const hasImg = (el) => el.getAttribute('data-has-image') === 'yes';
        const isPromo = (el) => el.getAttribute('data-promotion') === 'yes';

        // Tách Active/Rented
        let activeItems = filteredItems.filter(i => i.getAttribute('data-status') === 'active');
        let rentedItems = filteredItems.filter(i => i.getAttribute('data-status') === 'rented');

        const sortFn = (list) => {
            if (sortMode === 'price-asc') {
                list.sort((a, b) => getPrice(a) - getPrice(b));
            } else if (sortMode === 'price-desc') {
                list.sort((a, b) => getPrice(b) - getPrice(a));
            } else {
                // Mặc định: Promotion lên đầu
                list.sort((a, b) => (isPromo(b) ? 1 : 0) - (isPromo(a) ? 1 : 0));
            }
            // Luôn ưu tiên có ảnh
            list.sort((a, b) => (hasImg(b) ? 1 : 0) - (hasImg(a) ? 1 : 0));
        };

        sortFn(activeItems);
        sortFn(rentedItems);

        // Giới hạn Rented hiển thị
        if (rentedItems.length > 12) rentedItems = rentedItems.slice(0, 12);

        const finalSortedList = [...activeItems, ...rentedItems];

        // 3. RENDER LẠI DOM
        const container = document.getElementById('district-room-container');
        if (container) {
            // Ẩn hết trước
            allDomItems.forEach(el => el.style.display = 'none');
            
            // Append lại theo thứ tự đã sort
            finalSortedList.forEach(el => container.appendChild(el));

            // Hiển thị theo Items To Show
            finalSortedList.forEach((el, index) => {
                if (index < itemsToShow) {
                    el.style.display = 'block';
                    if (!el.classList.contains('animate__fadeIn')) {
                        el.classList.add('animate__animated', 'animate__fadeIn');
                    }
                }
            });
        }

        // 4. XỬ LÝ UI PHỤ (Nút Load More, No Result)
        const btnWrapper = document.getElementById('load-more-wrapper');
        const btn = document.getElementById('btn-load-more');
        const noResult = document.getElementById('no-result');

        if (btnWrapper && btn) {
            const remaining = Math.max(0, finalSortedList.length - itemsToShow);
            if (finalSortedList.length > itemsToShow) {
                btn.innerHTML = `Xem thêm ${remaining} căn nữa <i class="fas fa-chevron-down ms-2"></i>`;
                btnWrapper.style.display = 'block';
                btn.onclick = handleLoadMore; // Gán sự kiện trực tiếp
            } else if (finalSortedList.length > 0) {
                btnWrapper.style.display = 'block';
                btnWrapper.innerHTML = '<span class="text-muted small fst-italic">Đã hiển thị hết danh sách</span>';
            } else {
                btnWrapper.style.display = 'none';
            }
        }

        if (noResult) {
            if (finalSortedList.length === 0) noResult.classList.remove('d-none');
            else noResult.classList.add('d-none');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderRooms();
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) sortSelect.addEventListener('change', renderRooms);
    });
</script>