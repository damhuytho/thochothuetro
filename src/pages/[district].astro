---
import Layout from '../layouts/Layout.astro';
import SidebarFilter from '../components/SidebarFilter.astro';
import CardRoom from '../components/CardRoom.astro';
import CommitmentFooter from '../components/CommitmentFooter.astro';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const dataPath = path.join(process.cwd(), 'public', 'data.json');
  // Lấy TOÀN BỘ phòng (cả active và rented)
  const jsonData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
  
  // Lọc lấy phòng Active HOẶC Rented để hiển thị
  const validRooms = jsonData.rooms.filter(r => r.status === 'active' || r.status === 'rented');

  return [
    { params: { district: 'tan-binh' }, props: { districtName: 'Tân Bình', allRooms: validRooms.filter(r => r.district === 'Tân Bình') } },
    { params: { district: 'phu-nhuan' }, props: { districtName: 'Phú Nhuận', allRooms: validRooms.filter(r => r.district === 'Phú Nhuận') } }
  ];
}

const { districtName, allRooms } = Astro.props;

// --- LOGIC SẮP XẾP SERVER-SIDE (MẶC ĐỊNH) ---
// 1. Tách Active và Rented
const activeRooms = allRooms.filter(r => r.status === 'active');
const rentedRooms = allRooms.filter(r => r.status === 'rented');

// 2. Sắp xếp Active: Ưu tiên có Promotion
activeRooms.sort((a, b) => {
    if (a.promotion && !b.promotion) return -1;
    if (!a.promotion && b.promotion) return 1;
    return 0;
});

// 3. Giới hạn Rented: Chỉ lấy 9 căn mới nhất (giả sử danh sách gốc đã theo thứ tự mới nhất, nếu ko thì sort theo ID)
const limitedRentedRooms = rentedRooms.slice(0, 9);

// 4. Gộp lại: Active trước, Rented sau
const initialDisplayRooms = [...activeRooms, ...limitedRentedRooms];
---

<Layout title={`Cho thuê phòng trọ ${districtName} - Thọ Cho Thuê Trọ`}>
    
    <div class="container py-4">
        <div class="row">
            <div class="col-lg-3">
    <SidebarFilter />
</div>

            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-end mb-4 border-bottom border-warning pb-2">
                    <div>
                        <h1 class="h5 fw-bold text-dark m-0 text-uppercase">
                            <span class="text-warning me-2"><i class="fas fa-map-marker-alt"></i></span>
                            KHU VỰC {districtName}
                        </h1>
                    </div>

                    <div class="d-flex align-items-center">
                        <label for="sort-select" class="small fw-bold me-2 text-muted d-none d-md-block">Sắp xếp:</label>
                        <select id="sort-select" class="form-select form-select-sm border-warning shadow-sm" style="width: auto; font-weight: 500;">
                            <option value="default">Mặc định</option>
                            <option value="price-asc">Giá thấp đến cao</option>
                            <option value="price-desc">Giá cao đến thấp</option>
                        </select>
                    </div>
                </div>

                <div class="row g-2 g-md-3" id="district-room-container">
                    {initialDisplayRooms.map((room, idx) => (
                        <div class="col-6 col-md-4 room-item"
     data-district={room.district}
     data-price={room.price}
     data-type={room.type}
     data-status={room.status}
     data-promotion={room.promotion ? "yes" : "no"}
     data-keypoint={room.keypoint ? room.keypoint.toLowerCase() : ""}
     data-pet={room.pet ? "yes" : "no"}
     data-has-image={(room.image_detail && room.image_detail.length > 0) ? "yes" : "no"}
     data-district-index={idx}>
                            
                            <CardRoom room={room} />
                        
                        </div>
                    ))}
                </div>
                
                <div id="no-result" class="text-center py-5 d-none">
                    <img src="/logo.png" width="80" class="mb-3 opacity-50" style="filter: grayscale(1);">
                    <p class="text-muted">Không tìm thấy phòng phù hợp.</p>
                    <button class="btn btn-outline-warning text-dark fw-bold btn-sm" onclick="window.location.href=window.location.pathname">Xóa bộ lọc</button>
                </div>

                <div class="text-center mt-5 mb-4" id="load-more-wrapper">
                    <button id="btn-load-more" class="btn btn-outline-warning text-dark fw-bold px-5 rounded-pill shadow-sm">
                        Xem thêm 6 căn nữa <i class="fas fa-chevron-down ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <CommitmentFooter />

</Layout>

<script is:inline>
let itemsToShow = 6;
const ITEMS_PER_LOAD = 6;
let lastFilterParams = '';

function hasImageEl(el) {
    return el && el.getAttribute && el.getAttribute('data-has-image') === 'yes';
}

function handleLoadMore() {
    itemsToShow += ITEMS_PER_LOAD;
    renderRooms();
}

function renderRooms() {
    const params = new URLSearchParams(window.location.search);
    const currentFilterParams = params.toString();

    // Reset itemsToShow nếu filter thay đổi
    if (lastFilterParams !== currentFilterParams) {
        itemsToShow = 6;
        lastFilterParams = currentFilterParams;
    }

    const fType = (params.get('type') || 'all').toLowerCase();
    const fPrice = params.get('price');
    const fAmenitiesRaw = params.get('amenities') ? params.get('amenities').split(',') : [];
    const fAmenities = fAmenitiesRaw.map(a => (a || '').toString().trim().toLowerCase());
    const specialGroup = ['ban công', 'cửa sổ'];
    const selectedSpecial = fAmenities.filter(a => specialGroup.includes(a));
    const selectedNormal = fAmenities.filter(a => !specialGroup.includes(a));

    const sortMode = document.getElementById('sort-select') ? document.getElementById('sort-select').value : 'default';

    const allDomItems = Array.from(document.querySelectorAll('.room-item'));

    // FILTER
    const filteredItems = allDomItems.filter(item => {
        let matches = true;

        const itemDistrict = item.getAttribute('data-district');
        if (params.get('district') && params.get('district') !== 'all' && itemDistrict !== params.get('district')) matches = false;

        const itemType = (item.getAttribute('data-type') || '').toLowerCase();
        if (matches && fType !== 'all' && itemType !== fType) matches = false;

        if (matches && fPrice && fPrice !== 'all') {
            const price = parseInt(item.getAttribute('data-price')) / 1000000;
            if (fPrice === 'duoi-5' && price >= 5) matches = false;
            if (fPrice === '5to8' && (price < 5 || price >= 8)) matches = false;
            if (fPrice === 'over8' && price < 8) matches = false;
        }

        if (matches && fAmenities.length > 0) {
            const keypoints = (item.getAttribute('data-keypoint') || '').toLowerCase();
            const petAllowed = item.getAttribute('data-pet') === 'yes';

            for (let ami of selectedNormal) {
                if (!ami) continue;
                if (ami === 'nuôi pet' || ami === 'nuoi pet') {
                    if (!keypoints.includes('pet') && !keypoints.includes('thú cưng') && !petAllowed) { matches = false; break; }
                } else {
                    if (!keypoints.includes(ami)) { matches = false; break; }
                }
            }

            if (matches && selectedSpecial.length > 0) {
                let hasAtLeastOne = false;
                if (selectedSpecial.includes('ban công') && keypoints.includes('ban công')) hasAtLeastOne = true;
                if (selectedSpecial.includes('cửa sổ') && keypoints.includes('cửa sổ')) hasAtLeastOne = true;
                if (!hasAtLeastOne) matches = false;
            }
        }

        return matches;
    });

    // TÁCH ACTIVE VÀ RENTED
    let activeItems = filteredItems.filter(i => i.getAttribute('data-status') === 'active');
    let rentedItems = filteredItems.filter(i => i.getAttribute('data-status') === 'rented');

    // SẮP XẾP: theo sortMode cho active (price asc/desc hoặc promotion), sau đó đẩy có ảnh lên trước
    if (sortMode === 'price-asc') {
        activeItems.sort((a, b) => parseInt(a.getAttribute('data-price')) - parseInt(b.getAttribute('data-price')));
    } else if (sortMode === 'price-desc') {
        activeItems.sort((a, b) => parseInt(b.getAttribute('data-price')) - parseInt(a.getAttribute('data-price')));
    } else {
        activeItems.sort((a, b) => {
            const aPromo = a.getAttribute('data-promotion') === 'yes' ? 1 : 0;
            const bPromo = b.getAttribute('data-promotion') === 'yes' ? 1 : 0;
            return bPromo - aPromo;
        });
    }
    // Đảm bảo các item có ảnh đứng trên (giữ relative order)
    activeItems.sort((a, b) => (hasImageEl(b) ? 1 : 0) - (hasImageEl(a) ? 1 : 0));

    // Tương tự cho rented
    if (sortMode === 'price-asc') {
        rentedItems.sort((a, b) => parseInt(a.getAttribute('data-price')) - parseInt(b.getAttribute('data-price')));
    } else if (sortMode === 'price-desc') {
        rentedItems.sort((a, b) => parseInt(b.getAttribute('data-price')) - parseInt(a.getAttribute('data-price')));
    } else {
        rentedItems.sort((a, b) => {
            const aPromo = a.getAttribute('data-promotion') === 'yes' ? 1 : 0;
            const bPromo = b.getAttribute('data-promotion') === 'yes' ? 1 : 0;
            return bPromo - aPromo;
        });
    }
    rentedItems.sort((a, b) => (hasImageEl(b) ? 1 : 0) - (hasImageEl(a) ? 1 : 0));

    // GIỚI HẠN RENTED = max 10
    if (rentedItems.length > 10) rentedItems = rentedItems.slice(0, 10);

    // GỘP LẠI VÀ HIỂN THỊ (PAGING)
    const finalSortedList = [...activeItems, ...rentedItems];

    // Ẩn tất cả trước khi render lại thứ tự
    allDomItems.forEach(item => item.style.display = 'none');

    // Sắp xếp lại DOM (Visual order)
    const container = document.getElementById('district-room-container');
    finalSortedList.forEach(item => {
        container.appendChild(item);
    });

    // Hiển thị theo itemsToShow (mỗi lần click thêm 6)
    finalSortedList.forEach((item, index) => {
        if (index < itemsToShow) {
            item.style.display = 'block';
            item.classList.add('animate__animated', 'animate__fadeIn');
        } else {
            item.style.display = 'none';
        }
    });

    // Update nút Load More: show remaining = finalSortedList.length - itemsToShow
    const btnLoadMore = document.getElementById('load-more-wrapper');
    const remaining = Math.max(0, finalSortedList.length - itemsToShow);
    if (finalSortedList.length > itemsToShow) {
        btnLoadMore.innerHTML = `<button id="btn-load-more" class="btn btn-outline-warning text-dark fw-bold px-5 rounded-pill shadow-sm">Xem thêm ${remaining} căn nữa <i class="fas fa-chevron-down ms-2"></i></button>`;
        btnLoadMore.style.display = 'block';
        const newBtn = document.getElementById('btn-load-more');
        if (newBtn) {
            newBtn.removeEventListener('click', handleLoadMore);
            newBtn.addEventListener('click', handleLoadMore);
        }
    } else if (finalSortedList.length > 0 && finalSortedList.length <= itemsToShow) {
        btnLoadMore.innerHTML = '<p class="text-muted small">Đã xem hết danh sách</p>';
        btnLoadMore.style.display = 'block';
    } else {
        btnLoadMore.style.display = 'none';
    }

    // No result
    if (finalSortedList.length === 0) {
        document.getElementById('no-result').classList.remove('d-none');
    } else {
        document.getElementById('no-result').classList.add('d-none');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    renderRooms();
    document.addEventListener('click', (e) => {
        if (e.target && (e.target.id === 'btn-load-more' || e.target.closest('#btn-load-more'))) {
            handleLoadMore();
        }
    });
});
</script>