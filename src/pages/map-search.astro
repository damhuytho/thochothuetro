---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Load Data Server-Side
const dataPath = path.join(process.cwd(), 'public', 'data.json');
const jsonData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

// Lấy cả phòng Active và Rented
const allRooms = jsonData.rooms.filter(r => r.status === 'active' || r.status === 'rented');
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<Layout title="Bản đồ tìm phòng - Thọ Cho Thuê Trọ">
    
    <div class="map-layout-wrapper">
        
        <div id="full-map-view" class="map-viewport bg-white border-start position-relative"></div>

        <div class="map-sidebar bg-light d-flex flex-column">
            
            <div class="p-3 border-bottom bg-white shadow-sm" style="z-index: 10;">
                <h6 class="fw-bold mb-2 small text-uppercase d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-filter text-warning me-1"></i> Bộ lọc & Sắp xếp</span>
                    <span class="badge bg-light text-secondary border fw-normal cursor-pointer" onclick="resetMapFilters()">Xóa lọc</span>
                </h6>
                
                <div class="row g-2">
                    <div class="col-6">
                        <select class="form-select form-select-sm fw-bold border-warning" id="map-district">
                            <option value="all">Tất cả Khu vực</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="map-sort">
                            <option value="default">Sắp xếp: Mặc định</option>
                            <option value="price-asc">Giá: Thấp đến Cao</option>
                            <option value="price-desc">Giá: Cao đến Thấp</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="map-type">
                            <option value="all">Loại phòng: Tất cả</option>
                            <option value="Studio">Studio</option>
                            <option value="1PN">1 Phòng ngủ</option>
                            <option value="2PN">2 Phòng ngủ</option>
                            <option value="Duplex">Duplex</option>
                        </select>
                    </div>
                    <div class="col-6">
    <select class="form-select form-select-sm" id="map-price">
        <option value="all">Mức giá: Tất cả</option>
        <option value="duoi-5">Dưới 5 Triệu</option>
        <option value="5to8">5 - 8 Triệu</option> 
        <option value="over8">Trên 8 Triệu</option>
    </select>
</div>

                    <div class="col-12 mt-1">
                        <div class="row g-2" id="map-amenities">
                            <div class="col-6"><label class="btn btn-outline-secondary btn-sm w-100 border-0 bg-light small text-start"><input type="checkbox" class="form-check-input me-1 amenity-cb" value="ban công"> Ban công</label></div>
                            <div class="col-6"><label class="btn btn-outline-secondary btn-sm w-100 border-0 bg-light small text-start"><input type="checkbox" class="form-check-input me-1 amenity-cb" value="cửa sổ"> Cửa sổ</label></div>
                            <div class="col-6"><label class="btn btn-outline-secondary btn-sm w-100 border-0 bg-light small text-start"><input type="checkbox" class="form-check-input me-1 amenity-cb" value="máy giặt"> Máy giặt</label></div>
                            <div class="col-6"><label class="btn btn-outline-secondary btn-sm w-100 border-0 bg-light small text-start"><input type="checkbox" class="form-check-input me-1 amenity-cb" value="thang máy"> Thang máy</label></div>
                            <div class="col-6"><label class="btn btn-outline-secondary btn-sm w-100 border-0 bg-light small text-start"><input type="checkbox" class="form-check-input me-1 amenity-cb" value="pet"> Nuôi Pet</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-grow-1 p-2 p-md-3 list-scroll-container" id="map-list-container">
                <div class="row g-2" id="map-grid"></div>
                
                <div id="map-loading" class="text-center py-4 text-muted d-none">
                    <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                </div>
                <div id="map-no-result" class="text-center py-5 d-none">
                    <p class="text-muted small">Không tìm thấy phòng phù hợp vùng này.</p>
                </div>

                <div class="text-center py-3" id="map-load-more-container" style="display: none;">
                    <button class="btn btn-sm btn-outline-warning text-dark fw-bold rounded-pill px-4" onclick="loadMoreMapItems()">
                        Xem thêm 6 phòng <i class="fas fa-chevron-down ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</Layout>

<style>
    :global(footer) { display: none !important; }

    /* LAYOUT CHUNG */
    .map-layout-wrapper { display: flex; height: calc(100vh - 76px); overflow: hidden; }
    .map-sidebar { width: 400px; flex-shrink: 0; border-right: 1px solid #dee2e6; height: 100%; overflow: hidden; }
    .list-scroll-container { overflow-y: auto; height: 100%; }
    .map-viewport { flex-grow: 1; height: 100%; z-index: 1; }

    /* MOBILE LAYOUT */
    @media (max-width: 991px) {
        .map-layout-wrapper { flex-direction: column; height: auto !important; overflow: visible !important; }
        .map-viewport { height: 50vh; width: 100%; position: relative; flex-shrink: 0; }
        .map-sidebar { width: 100%; height: auto !important; overflow: visible !important; }
        .list-scroll-container { overflow: visible !important; height: auto !important; }
    }
    .text-truncate-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;       /* Giới hạn 3 dòng */
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal;         /* Cho phép xuống dòng */
    line-height: 1.4;            /* Khoảng cách dòng cho dễ đọc */
}

/* TÌM VÀ SỬA ĐOẠN CSS NÀY TRONG THẺ <style> */
.btn-popup-yellow {
    background-color: #f1c40f !important; /* Vàng thương hiệu */
    color: #1a1a1a !important; /* Chữ đen */
    font-weight: 700 !important;
    border: none;
    padding: 8px 15px; /* Tăng padding cho nút to đẹp hơn */
    border-radius: 50px; /* Bo tròn viên thuốc */
    font-size: 0.85rem;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    transition: all 0.2s;
    text-decoration: none !important; /* Bắt buộc bỏ gạch chân */
    display: block;
    text-align: center;
    margin-top: 5px;
}
.btn-popup-yellow:hover {
    background-color: #e0b40a !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    color: #000 !important;
}
    .custom-map-marker-yellow { filter: drop-shadow(0 3px 3px rgba(0,0,0,0.3)); }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script is:inline define:vars={{ initialRooms: allRooms }}>
    const allRoomsData = initialRooms;
    let map = null;
    let markersLayer = null;
    let currentFiltered = [];
    let visibleCount = 6;
    const LOAD_STEP = 6;
    
    // --- 1. HÀM RENDER CARD (ĐÃ CẬP NHẬT GIỐNG CARDROOM.ASTRO) ---
    function renderCardHTML(room) {
        const images = room.image_detail || [];
        
        // Logic tìm ảnh thumb
        let displayImg = '/logo.png';
        if (images.length > 0) {
            const thumb = images.find(img => img.includes('_thumb'));
            displayImg = thumb ? thumb : images[0];
        }

        // Ẩn số nhà
        const cleanAddr = room.address.replace(/^[0-9][0-9a-zA-Z\/,.-]*\s+/, '');
        const cardTitle = `Cho thuê căn ${room.type} ${cleanAddr}`;
        
        const priceText = room.price >= 1000000 ? (room.price / 1000000) + ' Triệu' : new Intl.NumberFormat('vi-VN').format(room.price);
        const link = `/${room.district === 'Tân Bình' ? 'tan-binh' : 'phu-nhuan'}/${room.id}`;
        
        const isRented = room.status === 'rented';
        const keypoint = room.keypoint ? room.keypoint.split('|')[0] : '';
        
        // Cấu trúc HTML y hệt CardRoom.astro
        return `
        <div class="col-6"> 
            <div class="card h-100 border-0 shadow-sm room-card rounded-3 overflow-hidden position-relative ${isRented ? 'rented-card' : ''}" 
                 onclick="window.location.href='${link}'" style="cursor: pointer;">
                
                <div class="position-relative">
                    <img src="${displayImg}" class="card-img-top room-img" alt="${room.room_code}" loading="lazy" style="aspect-ratio: 4/3; object-fit: cover; width: 100%;">
                    
                    ${isRented ? `
                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center rented-overlay" style="background: rgba(0,0,0,0.6); z-index: 5;">
                        <span class="text-white fw-bold border border-white px-2 py-1 rounded small text-uppercase">
                            Đã cho thuê
                        </span>
                    </div>` : ''}

                    ${!isRented && room.promotion ? `
                    <span class="position-absolute top-0 end-0 bg-warning text-dark px-2 py-1 small fw-bold m-2 rounded shadow-sm d-flex align-items-center badge-promo" style="z-index: 2;">
                        <i class="fas fa-gift me-1 text-dark"></i> Ưu đãi
                    </span>` : ''}
                </div>
                
                <div class="card-body p-2 p-md-3 d-flex flex-column">
                    <h6 class="fw-bold text-dark mb-1 mb-md-2 room-title text-truncate-3">
                        ${cardTitle}
                    </h6>
                    <div class="mb-1 mb-md-2">
                        <span class="badge bg-light text-secondary border fw-normal room-code">
                            ${room.room_code}
                        </span>
                    </div>
                    <div class="mb-1 mb-md-2">
                        <span class="fw-bold room-price ${isRented ? 'text-secondary text-decoration-line-through' : 'text-danger'}">
                            ${priceText}/tháng
                        </span>
                    </div>
                    <div class="mb-2 mb-md-3 text-muted room-keypoint text-truncate-2">
                        <i class="fas fa-star text-warning me-1"></i> ${keypoint}
                    </div>
                    <div class="mt-auto">
                        <hr class="my-1 my-md-2 opacity-25">
                        <div class="d-flex align-items-center text-muted room-district">
                            <i class="fas fa-map-marker-alt me-1 me-md-2 text-warning"></i> 
                            Quận ${room.district}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // --- 2. LOGIC LỌC & SẮP XẾP ---
    // --- 2. LOGIC LỌC & SẮP XẾP (ĐÃ ĐỒNG BỘ VỚI INDEX.ASTRO) ---
    function filterAndRender() {
        // 1. Lấy giá trị từ UI
        const district = document.getElementById('map-district').value;
        const type = document.getElementById('map-type').value;
        const price = document.getElementById('map-price').value;
        const sortMode = document.getElementById('map-sort').value;

        // Lấy danh sách tiện ích đã check
        // Lưu ý: value của checkbox trong HTML map-search đang là: 'ban công', 'cửa sổ', 'máy giặt', 'thang máy', 'pet'
        const fAmenities = Array.from(document.querySelectorAll('.amenity-cb:checked')).map(cb => cb.value.toLowerCase());

        // Phân loại tiện ích giống logic index.astro
        const specialGroup = ['ban công', 'cửa sổ'];
        const selectedSpecial = fAmenities.filter(a => specialGroup.includes(a));
        const selectedNormal = fAmenities.filter(a => !specialGroup.includes(a));

        // 2. Bắt đầu lọc
        let filtered = allRoomsData.filter(room => {
            let matches = true;

            // --- Lọc Khu vực ---
            if (district !== 'all' && room.district !== district) matches = false;
            
            // --- Lọc Loại phòng ---
            if (matches && type !== 'all' && room.type !== type) matches = false;
            
            // --- Lọc Giá (Đã sửa logic theo 5-8tr) ---
            if (matches && price !== 'all') {
                const p = room.price; // Giá gốc là số
                if (price === 'duoi-5' && p >= 5000000) matches = false;
                if (price === '5to8' && (p < 5000000 || p >= 8000000)) matches = false;
                if (price === 'over8' && p < 8000000) matches = false;
            }

            // --- Lọc Tiện ích (Logic chuẩn VÀ + Nhóm View) ---
            if (matches && fAmenities.length > 0) {
                const keypoints = (room.keypoint || "").toLowerCase();
                const petAllowed = room.pet === true; // Data gốc có trường boolean pet

                // 1. Kiểm tra nhóm thường (Logic AND: Phải có TẤT CẢ)
                for (let ami of selectedNormal) {
                    if (!ami) continue;
                    
                    if (ami === 'pet' || ami === 'nuôi pet') {
                        // Check pet kỹ: xem field pet hoặc tìm text trong keypoint
                        const hasPetText = keypoints.includes('pet') || keypoints.includes('thú cưng');
                        if (!hasPetText && !petAllowed) { 
                            matches = false; 
                            break; 
                        }
                    } else {
                        // Các tiện ích khác: máy giặt, thang máy...
                        if (!keypoints.includes(ami)) { 
                            matches = false; 
                            break; 
                        }
                    }
                }

                // 2. Kiểm tra nhóm đặc biệt (Logic OR: Có ít nhất 1 trong nhóm Ban công/Cửa sổ)
                // Chỉ chạy check này nếu user có chọn ít nhất 1 cái trong nhóm special
                if (matches && selectedSpecial.length > 0) {
                    let hasAtLeastOne = false;
                    if (selectedSpecial.includes('ban công') && keypoints.includes('ban công')) hasAtLeastOne = true;
                    if (selectedSpecial.includes('cửa sổ') && keypoints.includes('cửa sổ')) hasAtLeastOne = true;
                    
                    if (!hasAtLeastOne) matches = false;
                }
            }

            return matches;
        });

        // 3. Sắp xếp (Giữ nguyên logic cũ)
        filtered.sort((a, b) => {
            // Ưu tiên phòng còn trống lên đầu
            if (a.status !== b.status) return a.status === 'active' ? -1 : 1;
            
            if (sortMode === 'price-asc') return a.price - b.price;
            else if (sortMode === 'price-desc') return b.price - a.price;

            // Mặc định: Ưu tiên có ảnh
            const aImg = (a.image_detail && a.image_detail.length > 0) ? 1 : 0;
            const bImg = (b.image_detail && b.image_detail.length > 0) ? 1 : 0;
            return bImg - aImg;
        });

        // 4. Phân trang & Render lại
        const activeRooms = filtered.filter(r => r.status === 'active');
        let rentedRooms = filtered.filter(r => r.status === 'rented');
        
        // Giới hạn phòng đã thuê hiển thị max 10 căn để không làm rác bản đồ
        if (rentedRooms.length > 10) rentedRooms = rentedRooms.slice(0, 10);
        
        currentFiltered = [...activeRooms, ...rentedRooms];
        visibleCount = 6; // Reset số lượng hiển thị khi lọc lại
        
        renderListDOM();
        renderMapMarkers();
    }

    // --- 3. RENDER LIST ---
    function renderListDOM() {
        const grid = document.getElementById('map-grid');
        const loadMoreBtn = document.getElementById('map-load-more-container');
        const noResult = document.getElementById('map-no-result');

        const visibleItems = currentFiltered.slice(0, visibleCount);
        grid.innerHTML = visibleItems.map(renderCardHTML).join('');

        if (currentFiltered.length > visibleCount) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.querySelector('button').innerHTML = `Xem thêm ${Math.min(LOAD_STEP, currentFiltered.length - visibleCount)} phòng <i class="fas fa-chevron-down ms-1"></i>`;
        } else {
            loadMoreBtn.style.display = 'none';
        }

        if (currentFiltered.length === 0) noResult.classList.remove('d-none');
        else noResult.classList.add('d-none');
    }

    // --- 4. RENDER MAP MARKERS ---
    function renderMapMarkers() {
        if (!map) return;
        if (markersLayer) map.removeLayer(markersLayer);
        markersLayer = L.layerGroup().addTo(map);

        const brandIcon = L.divIcon({ 
            className: 'custom-map-marker-yellow', 
            html: '<div style="background:#f1c40f; width:34px; height:34px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; box-shadow:0 3px 5px rgba(0,0,0,0.3); color:#1a1a1a;"><i class="fas fa-home" style="font-size:16px;"></i></div>', 
            iconSize: [34, 34], iconAnchor: [17, 34], popupAnchor: [0, -40]
        });

        const bounds = [];
        currentFiltered.forEach(room => {
            if (room.lat && room.lng) {
                const images = room.image_detail || [];
                let popupImg = '/logo.png';
                if (images.length > 0) {
                     const thumb = images.find(img => img.includes('_thumb'));
                     popupImg = thumb ? thumb : images[0];
                }
                const link = `/${room.district === 'Tân Bình' ? 'tan-binh' : 'phu-nhuan'}/${room.id}`;
                const priceText = room.price >= 1000000 ? (room.price / 1000000) + ' Triệu' : new Intl.NumberFormat('vi-VN').format(room.price);

                const marker = L.marker([room.lat, room.lng], {icon: brandIcon}).addTo(markersLayer);
                const popupContent = `
                    <div style="width:200px;">
                        <img src="${popupImg}" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:8px;">
                        <div class="fw-bold text-dark mb-1" style="font-size:0.9rem;">${room.room_code}</div>
                        <div class="text-danger fw-bold mb-2">${priceText}/th</div>
                        <a href="${link}" class="btn-popup-yellow w-100 rounded-pill">Xem phòng</a>
                    </div>
                `;
                marker.bindPopup(popupContent);
                bounds.push([room.lat, room.lng]);
            }
        });
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
    }

    window.loadMoreMapItems = function() { visibleCount += LOAD_STEP; renderListDOM(); }
    window.resetMapFilters = function() {
        document.getElementById('map-district').value = 'all';
        document.getElementById('map-type').value = 'all';
        document.getElementById('map-price').value = 'all';
        document.getElementById('map-sort').value = 'default';
        document.querySelectorAll('.amenity-cb').forEach(cb => cb.checked = false);
        filterAndRender();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- [PHẦN MỚI THÊM] BẮT ĐẦU TỪ ĐÂY ---
        // 1. Tự động lấy danh sách Quận từ data
        const districtSelect = document.getElementById('map-district');
        // Lấy các quận unique (không trùng nhau) từ allRoomsData
        const districts = [...new Set(allRoomsData.map(r => r.district))].sort();
        
        // Tạo option và chèn vào select
        districts.forEach(d => {
            const option = document.createElement('option');
            option.value = d;
            option.textContent = d; // Hoặc chỉ để d nếu data đã có chữ Quận
            districtSelect.appendChild(option);
        });
        
        // Set mặc định là Phú Nhuận (Nếu data có quận Phú Nhuận)
        if (districts.includes('Phú Nhuận')) {
            districtSelect.value = 'Phú Nhuận';
        }
        // --- [KẾT THÚC PHẦN MỚI THÊM] ---
        map = L.map('full-map-view').setView([10.801646, 106.663158], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        const inputs = document.querySelectorAll('select, .amenity-cb');
        inputs.forEach(input => { input.addEventListener('change', filterAndRender); });

        filterAndRender();
    });
</script>