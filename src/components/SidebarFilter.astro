---
// src/components/SidebarFilter.astro
import fs from 'node:fs';
import path from 'node:path';

// 1. DATA SERVER-SIDE
let uniqueDistricts = [];
try {
    const dataPath = path.join(process.cwd(), 'public', 'data.json');
    const jsonData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
    uniqueDistricts = [...new Set(jsonData.rooms.map(r => r.district).filter(d => d))].sort();
} catch (error) {
    console.error("Lỗi đọc data.json:", error);
    uniqueDistricts = ["Tân Bình", "Phú Nhuận"]; 
}

// 2. DANH SÁCH CỐ ĐỊNH
const listTypes = ["Studio", "1PN", "2PN", "3PN", "Duplex", "Nguyên căn"];
const listPrices = [
    { label: "Dưới 5 triệu", value: "duoi-5" },
    { label: "Từ 5 - 8 triệu", value: "5to8" },
    { label: "Trên 8 triệu", value: "over8" }
];
const listAmenities = ["ban công", "cửa sổ", "tách bếp", "nuôi pet", "máy giặt riêng", "thang máy"];

// 3. LẤY PARAMS HIỆN TẠI
const { searchParams } = Astro.url;
const currentDist = searchParams.get('district') || 'all';
const currentType = searchParams.get('type') || 'all';
const currentPrice = searchParams.get('price') || 'all';
const currentAms = searchParams.get('amenities') ? searchParams.get('amenities').split(',') : [];
---

<div id="mobile-filter-bar" class="mobile-filter-bar d-lg-none">
    <div class="container d-flex align-items-center h-100 px-3">
        <div class="filter-status-wrapper d-flex align-items-center flex-grow-1 overflow-hidden">
            <div class="filter-icon-box me-2">
                <i class="fas fa-sliders-h"></i>
            </div>
            <div class="filter-tags-scroll" id="filter-tags-container"></div>
        </div>
        <button type="button" class="btn-clear-filter" onclick="handleResetFilter()">
            <i class="fas fa-redo-alt me-1"></i> <span>Xóa</span>
        </button>
    </div>
</div>

<div class="sidebar-sticky-wrapper" id="sidebar-wrapper">
    <div class="card border-0 shadow-sm rounded-3 overflow-hidden bg-white">
        <div class="card-header text-dark fw-bold text-uppercase py-2 d-flex align-items-center" 
             style="background-color: #f1c40f; border-bottom: 1px solid #e0b40a;">
            <i class="fas fa-filter me-2"></i> TÌM KIẾM
        </div>

        <!-- FORM BODY - CÓ ID ĐỂ ẨNHIỂN -->
        <div class="card-body p-3 bg-white" id="filter-form-body">
            <form id="astro-filter-form">
                
                <div class="mb-2">
                    <label class="filter-label">KHU VỰC</label>
                    <select class="form-select custom-select fw-bold" id="sb-district">
                        <option value="all">-- Tất cả --</option>
                        {uniqueDistricts.map((dist) => (
                            <option value={dist} selected={currentDist === dist}>Quận {dist}</option>
                        ))}
                    </select>
                </div>

                <div class="mb-2">
                    <label class="filter-label">LOẠI PHÒNG</label>
                    <select class="form-select custom-select" id="sb-type">
                        <option value="all">-- Tất cả --</option>
                        {listTypes.map((type) => (
                            <option value={type} selected={currentType === type}>{type}</option>
                        ))}
                    </select>
                </div>

                <div class="mb-2">
                    <label class="filter-label">MỨC GIÁ</label>
                    <select class="form-select custom-select" id="sb-price">
                        <option value="all">-- Tất cả --</option>
                        {listPrices.map((p) => (
                            <option value={p.value} selected={currentPrice === p.value}>{p.label}</option>
                        ))}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="filter-label">TIỆN ÍCH</label>
                    <div class="row g-2">
                        {listAmenities.map((am) => (
                            <div class="col-6">
                                <label class="custom-check">
                                    <input type="checkbox" class="sb-amenity" value={am} checked={currentAms.includes(am)}>
                                    <span class="checkmark"></span> 
                                    <span class="text-capitalize">{am}</span>
                                </label>
                            </div>
                        ))}
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" id="btn-apply" class="btn btn-warning flex-grow-1 fw-bold text-dark shadow-sm py-2">
                        ÁP DỤNG
                    </button>
                    <button type="button" id="btn-reset" class="btn btn-light border flex-grow-1 fw-bold text-secondary shadow-sm py-2">
                        ĐẶT LẠI
                    </button>
                </div>

            </form>
        </div>

        <!-- NÚT TOGGLE FILTER (ẨN KHI EXPANDED) -->
        <div id="toggle-filter-btn-container" class="p-3 bg-white">
    <button type="button" id="btn-toggle-filter" class="btn btn-warning w-100 fw-bold text-dark shadow-sm py-2">
        <i class="fas fa-chevron-down me-2"></i> HIỂN THỊ BỘ LỌC
    </button>
</div>
    </div>
</div>

<style>
    /* --- CSS MOBILE FILTER BAR (THANH LỌC NGANG TRÊN CÙNG) --- */
    .mobile-filter-bar {
        position: fixed;
        top: 0; 
        left: 0;
        width: 100%;
        background: #fff;
        z-index: 2000; /* Cao hơn Navbar */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 8px 15px;
        display: none; /* Mặc định ẩn, hiện bằng JS */
        border-bottom: 1px solid #eee;
        height: 60px; /* Chiều cao cố định */
    }

    /* Khi active thì hiện flex */
    .mobile-filter-bar.is-visible {
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from { transform: translateY(-100%); }
        to { transform: translateY(0); }
    }

    .filter-tags-scroll {
        flex: 1;
        display: flex;
        overflow-x: auto; /* Cuộn ngang */
        white-space: nowrap;
        gap: 8px;
        margin-right: 10px;
        padding-bottom: 2px;
        -webkit-overflow-scrolling: touch;
        /* Ẩn scrollbar */
        scrollbar-width: none; 
    }
    .filter-tags-scroll::-webkit-scrollbar { display: none; }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 50px; /* Bo tròn viên thuốc */
        padding: 4px 12px;
        font-size: 0.75rem;
        font-weight: 600;
        flex-shrink: 0; /* Không bị co lại */
    }

    /* Tag giá màu nổi bật */
    .filter-tag.price-tag {
        background: #fff3cd;
        color: #856404;
        border-color: #ffeeba;
    }

    .btn-clear-filter {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 5px 12px;
        font-size: 0.75rem;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
    }

    /* --- GIỮ NGUYÊN CSS DESKTOP CŨ --- */
    .sidebar-sticky-wrapper {
        position: -webkit-sticky;
        position: sticky;
        top: 80px;
        z-index: 90;
        height: fit-content;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
    }
    .col-lg-3 { overflow: visible !important; }
    .filter-label { font-weight: 700; font-size: 0.75rem; color: #666; margin-bottom: 4px; text-transform: uppercase; }
    .custom-select { border: 1px solid #f1c40f !important; font-size: 0.85rem; cursor: pointer; }
    .custom-check { display: flex; align-items: center; cursor: pointer; font-size: 0.95rem; margin-bottom: 3px; }
    .custom-check input { display: none; }
    .checkmark { height: 16px; width: 16px; border: 1px solid #f1c40f; background-color: white; border-radius: 3px; margin-right: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .custom-check input:checked ~ .checkmark { background-color: #f1c40f; }
    .custom-check input:checked ~ .checkmark:after { content: '\2713'; color: #212529; font-size: 11px; font-weight: bold; }
    
    /* Ẩn form mặc định trên mobile để cho gọn */
    #filter-form-body { 
        opacity: 1; 
        max-height: 1000px; 
        overflow: hidden; 
        transition: all 0.3s ease; 
    }
    
    /* Khi có class collapsed thì ẩn form đi */
    #filter-form-body.collapsed { 
        opacity: 0; 
        max-height: 0; 
        padding: 0 !important; 
        pointer-events: none; 
    }

    /* Mặc định ẨN nút toggle (để desktop không thấy) */
    #toggle-filter-btn-container { 
        display: none; 
    }

    /* Chỉ hiện nút toggle khi có class visible (Mobile sẽ thêm class này bằng JS) */
    #toggle-filter-btn-container.visible { 
        display: block !important; 
        padding: 10px 15px !important;
    }

    /* Desktop: Luôn hiện form, luôn ẩn nút toggle */
    @media (min-width: 992px) {
        #filter-form-body { display: block !important; opacity: 1 !important; max-height: none !important; }
        #toggle-filter-btn-container { display: none !important; }
    }
</style>

<script is:inline>
    // 1. Logic Điều hướng & Lọc (Yêu cầu 1 của bạn)
    function handleApplyFilter() {
        const district = document.getElementById('sb-district').value;
        const type = document.getElementById('sb-type').value;
        const price = document.getElementById('sb-price').value;
        
        const amenities = [];
        document.querySelectorAll('.sb-amenity:checked').forEach((cb) => {
            amenities.push(cb.value);
        });

        const params = new URLSearchParams(window.location.search);
        
        // Cập nhật params
        if (type !== 'all') params.set('type', type); else params.delete('type');
        if (price !== 'all') params.set('price', price); else params.delete('price');
        if (amenities.length > 0) params.set('amenities', amenities.join(',')); else params.delete('amenities');
        
        // --- LOGIC QUAN TRỌNG: CHUYỂN TRANG THEO QUẬN ---
        // Xóa param district vì nó sẽ nằm trên đường dẫn
        params.delete('district'); 

        let targetPath = '/';
        if (district !== 'all') {
            // Chuyển tên quận thành slug (Ví dụ: Tân Bình -> tan-binh)
            if (district === 'Tân Bình') targetPath = '/tan-binh';
            else if (district === 'Phú Nhuận') targetPath = '/phu-nhuan';
            else targetPath = '/' + district.toLowerCase().replace(/ /g, '-');
        }

        // Tạo URL đích
        const queryString = params.toString();
        const finalUrl = queryString ? `${targetPath}?${queryString}` : targetPath;
        
        window.location.href = finalUrl;
    }

    // 2. Logic Hiển thị thanh lọc Mobile (Yêu cầu 3 của bạn)
    function renderMobileActiveTags() {
        const container = document.getElementById('filter-tags-container');
        const bar = document.getElementById('mobile-filter-bar');
        if (!container || !bar) return;

        const params = new URLSearchParams(window.location.search);
        let tagsHtml = '';
        let hasFilter = false;

        // Kiểm tra loại phòng
        if(params.get('type') && params.get('type') !== 'all') { 
            tagsHtml += `<span class="filter-tag">${params.get('type')}</span>`;
            hasFilter = true; 
        }
        
        // Kiểm tra giá
        const p = params.get('price');
        if (p && p !== 'all') {
            let label = p === 'duoi-5' ? '< 5 Triệu' : (p === '5to8' ? '5-8 Triệu' : '> 8 Triệu');
            tagsHtml += `<span class="filter-tag price-tag">${label}</span>`;
            hasFilter = true;
        }

        // Kiểm tra tiện ích
        const ams = params.get('amenities');
        if(ams) {
            ams.split(',').forEach(a => {
                tagsHtml += `<span class="filter-tag">${a}</span>`;
            });
            hasFilter = true;
        }

        container.innerHTML = tagsHtml;
        
        // Nếu có filter thì hiện thanh bar, ngược lại ẩn
        if (hasFilter && window.innerWidth < 992) {
            bar.classList.add('is-visible');
        } else {
            bar.classList.remove('is-visible');
        }
    }

    // Các hàm phụ trợ khác (Collapse/Expand)
    window.toggleFilterVisibility = function() {
        const formBody = document.getElementById('filter-form-body');
        const toggleBtn = document.getElementById('toggle-filter-btn-container');
        if (formBody) {
            formBody.classList.toggle('collapsed');
            if (toggleBtn) toggleBtn.classList.toggle('visible');
        }
    }

    window.handleResetFilter = function() {
        // Reset về trang hiện tại nhưng bỏ hết query params
        window.location.href = window.location.pathname;
    }

    // Khởi chạy
    document.addEventListener('DOMContentLoaded', () => {
        const btnApply = document.getElementById('btn-apply');
        const btnReset = document.getElementById('btn-reset');
        const btnToggle = document.getElementById('btn-toggle-filter');
        
        if (btnApply) btnApply.onclick = handleApplyFilter;
        if (btnReset) btnReset.onclick = window.handleResetFilter;
        if (btnToggle) btnToggle.onclick = window.toggleFilterVisibility;

        // Điền lại dữ liệu vào form từ URL
        const params = new URLSearchParams(window.location.search);
        
        // Xác định quận hiện tại dựa trên URL Path
        let currentPathDist = 'all';
        if (window.location.pathname.includes('tan-binh')) currentPathDist = 'Tân Bình';
        if (window.location.pathname.includes('phu-nhuan')) currentPathDist = 'Phú Nhuận';
        
        const distEl = document.getElementById('sb-district');
        if (distEl) distEl.value = currentPathDist;

        const typeEl = document.getElementById('sb-type');
        if (typeEl) typeEl.value = params.get('type') || 'all';

        const priceEl = document.getElementById('sb-price');
        if (priceEl) priceEl.value = params.get('price') || 'all';

        const ams = params.get('amenities');
        if (ams) {
            const list = ams.split(',');
            document.querySelectorAll('.sb-amenity').forEach(cb => {
                if (list.includes(cb.value)) cb.checked = true;
            });
        }

        // Render thanh mobile
        renderMobileActiveTags();

        // Tự động thu gọn filter form trên mobile nếu đang ở trang chi tiết quận
        if (window.innerWidth < 992) {
            const formBody = document.getElementById('filter-form-body');
            const toggleBtn = document.getElementById('toggle-filter-btn-container');
            if (formBody) formBody.classList.add('collapsed');
            if (toggleBtn) toggleBtn.classList.add('visible');
        }
    });
</script>